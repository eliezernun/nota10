var TargetSelection;!function(){"use strict";(TargetSelection=function(e){var t=this;this.$container=null,this.on_confirm_village=function(e){},this.request_id=0,this.selected_index=null,this.num_villages=0,this.page_limit=null,this.last_attacked=null,this.autocomplete_visible=!1,this.ie_compatibility_mode=!0,this.confirmed_village_data=!1,this.read_only=!1,this.clicked_button="attack",this.autocomplete_wrapper=null,this.input_text_field=null,this.script_watcher=null,this.script_old_x="",this.script_old_y="",this.construct=function(e){var i=$(e);this.$container=i,this.input_text_field=i.find("input[type=text]"),this.initAutoComplete(),this.changeSearchType.call(i.find("input[type=radio]:checked"),!1),this.page_limit=Math.min(Math.max(Math.round(($(window).height()-this.input_text_field.offset().top)/50),5),10),this.setAutoCompleteWrapperPosition(),this.input_text_field.on("input",function(){t.ie_compatibility_mode=!1,t.fetchVillages()}).on("keyup",t.textFieldKeyUp).on("keydown",t.textFieldKeyDown).on("remove",t.destroy),i.find("input[type=radio]").on("change",this.changeSearchType),this.input_text_field.parents("form").on("submit",this.beforeSubmit),$(window).on("click",this.onWindowClick),i.find(".btn").on("click",function(){t.clicked_button=$(this).attr("name")});var a=i.data("on-choice");a&&this.setConfirmHook(a)},this.destroy=function(){clearInterval(t.script_watcher),$(window).off("click",t.onWindowClick),this.input_text_field=null},this.onWindowClick=function(){t.autocomplete_visible&&t.hideAutoCompleteWrapper()},this.initAutoComplete=function(){this.$container.find(".target-input-autocomplete").autocomplete({minLength:2,source:UI.AutoComplete.source}),this.input_text_field.on("autocompleteselect",function(e,i){t.fetchVillages({input:i.item.value})})},this.initScriptCompatibility=function(){clearInterval(this.script_watcher),this.script_watcher=setInterval(this.checkForScriptChange,100)},this.checkForScriptChange=function(){var e=$("#inputx").val(),i=$("#inputy").val(),a=t.confirmed_village_data?t.confirmed_village_data.x:"",l=t.confirmed_village_data?t.confirmed_village_data.y:"";e&&i&&(e!==a||i!==l)&&(clearInterval(t.script_watcher),t.setVillageByCoordinates(e,i,function(){$("#inputx").val(""),$("#inputy").val(""),t.initScriptCompatibility()}))},this.setReadOnly=function(){this.read_only=!0},this.setLastAttacked=function(e){this.last_attacked=e,this.$container.find(".target-last-attacked").show().on("click",function(e){e.preventDefault(),t.confirmVillage(t.getVillageDiv(t.last_attacked))})},this.enableQuickButton=function(e,t){$(".target-"+e).show().on("click",function(e){TargetSelection.loadTargetsPopup(e,t)})},this.setVillageByCoordinates=function(e,i,a){this.fetchVillages({type:"coord",input:e+"|"+i},function(e){e.villages.length&&t.confirmVillage(t.getVillageDiv(e.villages[0])),"function"==typeof a&&a()})},this.setVillageByData=function(e){this.confirmVillage(t.getVillageDiv(e))},this.beforeSubmit=function(){var e,i=$("#inputx"),a=$("#inputy"),l=t.$container.find(".target-input .village-item");if(l.length){var n=l.data("village_data");i.val(n.x),a.val(n.y)}return(e=t.$container.find("input[type=text]").val().match(/^([0-9]{1,3})\|([0-9]{1,3})$/))&&(i.val(e[1]),a.val(e[2])),!0},this.changeSearchType=function(e){var i,a=$(this),l=a.closest(".target-select").find("input[type=text]");switch(a.val()){case"coord":i="123|456";break;case"village_name":i=_("0b0415688c7513bb82d3c0e0835bd002");break;case"player_name":i=_("8db61ba8bc85fde639110b3098e827bb")}l.attr("placeholder",i).data("search-type",a.val()),t.clearVillages(),"player_name"===a.val()?(l.autocomplete("enable"),l.autocomplete("search")):l.autocomplete("disable"),!1!==e&&l.focus()},this.clearVillages=function(){this.hideAutoCompleteWrapper(),this.removeConfirmedVillage()},this.fetchVillages=function(e,i){var a={ajax:"target_selection",input:this.$container.find("input[type=text]").val(),type:this.$container.find("input[type=radio]:checked").val(),request_id:++this.request_id,limit:this.page_limit,offset:0};0!==(a=$.extend(a,e)).input.length&&(void 0===i&&(i=function(e){t.handleVillagesData(e)}),TribalWars.get("api",a,i))},this.handleVillagesData=function(e){if(e.request_id===this.request_id){var i=this.getAutoCompleteWrapper();if(this.hideAutoCompleteWrapper(),this.num_villages=e.villages.length+e.offset,0===e.offset?(this.selected_index=null,i.empty()):i.find(".village-more").remove(),0!==e.villages.length){if(this.showAutoCompleteWrapper(),$.each(e.villages,function(e,a){i.append(t.getVillageDiv(a))}),e.more){var a=$('<div class="village-item village-more">'+_("146ffe2fd9fa5bec3b63b52543793ec7")+"</div>").on("click",function(e){e.stopPropagation(),t.loadMoreVillages()});i.append(a)}this.setAutoCompleteWrapperPosition()}}},this.showAutoCompleteWrapper=function(){this.getAutoCompleteWrapper().show(),this.autocomplete_visible=!0},this.hideAutoCompleteWrapper=function(){"player_name"===this.$container.find(".input[type=radio]:checked").val()&&this.input_text_field.autocomplete("enable"),this.getAutoCompleteWrapper().hide(),this.autocomplete_visible=!1},this.getAutoCompleteWrapper=function(){return this.autocomplete_wrapper||(this.autocomplete_wrapper=$('<div class="target-select-autocomplete"></div>').appendTo("body")),this.autocomplete_wrapper},this.setAutoCompleteWrapperPosition=function(){var e=this.getAutoCompleteWrapper(),t=this.$container.find(".target-input"),i=t.offset(),a=t.height();e.css("width",t.width()+2+"px"),e.css("max-height",50*this.page_limit+"px"),e.css("left",i.left);var l=e.height();l>$(document).height()-i.top-a-$("#footer").height()?(e.css("top",i.top-l-2+"px"),e.css({"border-top-width":"1px","border-bottom-width":"0px"})):(e.css("top",i.top+a+2+"px"),e.css({"border-top-width":"0px","border-bottom-width":"1px"}))},this.setConfirmHook=function(e){for(var t=e.split("."),i=t.pop(),a=window,l=0;l<t.length;l++)a=a[t[l]];var n=a[i];if("function"!=typeof n)throw"non-existent function specified for TargetSelection on-choice";this.on_confirm_village=n},this.confirmVillage=function(e){this.removeConfirmedVillage(),this.getAutoCompleteWrapper().hide();var t=this.$container.find(".target-input");t.find("input").hide(),t.append(e),e.removeClass("village-selected"),this.confirmed_village_data=e.data("village_data"),this.updateURLForConfirmedVillage(),this.on_confirm_village(this.confirmed_village_data)},this.removeConfirmedVillage=function(){var e=this.$container.find(".target-input");e.find(".village-item").length&&(e.find("input").show().val("").focus(),e.find(".village-item").remove(),this.confirmed_village_data=!1,$("input[name=x], input[name=y]").val(""),this.updateURLForConfirmedVillage())},this.getVillageDiv=function(e){var i=$('<div class="village-item"><img class="village-delete" alt="" /><img class="village-picture" alt="" /><span class="village-name"></span><span class="village-info"></span><span class="village-distance"></span></div>').data("village_data",e);this.read_only||i.on("click",function(e){e.stopPropagation(),$(this).parent().hasClass("target-select-autocomplete")?t.confirmVillage(i):t.removeConfirmedVillage()});var a=e.name;a.length>18&&(a=a.substr(0,18)+"&hellip;");var l=s("%1 (%2|%3)",a,e.x,e.y),n=e.player_name?e.player_name:_("0a697cba19cd4c1974e2ee11a3c0b9c7"),o="<strong>"+_("13c5c6614ffee1464fd8f257d23151a4")+"</strong> "+n+" <strong>"+_("bde4bea69ecac47075ec76f575513829")+"</strong> "+e.points,c=Math.round(Math.sqrt(e.distance)),r=1===c?s(_("ba2b365358d84111ebec5eab11ed9676"),c):s(_("b7e6ef7cb6adca76ea4a73f1b0e4c3b7"),c),d="<strong>"+_("d7ecc20be02635c8fd9ba717df02a66b")+"</strong> "+r,h=i.find(".village-picture");return h.attr("src",e.image),e.siege_village&&h.addClass("siege-village"),i.find(".village-delete").attr("src",image_base+"/delete.png"),i.find(".village-name").html(l),i.find(".village-info").html(o),i.find(".village-distance").html(d),this.read_only&&i.addClass("read-only"),i},this.textFieldKeyUp=function(e){t.ie_compatibility_mode&&38!==e.keyCode&&40!==e.keyCode&&t.fetchVillages();var i=$(this),a=i.val();return"coord"===i.data("search-type")&&(3===(a=(a=a.replace(/[,\.]/,"|")).replace(/[^[0-9\|]+/,"")).length&&8!==e.keyCode&&46!==e.keyCode&&(a+="|"),-1!==a.indexOf("||")&&(a=a.replace(/(\|{2,})/,"|")),a.length>7&&(a=a.substr(0,7)),i.val(a)),!0},this.textFieldKeyDown=function(e){return 38===e.keyCode?(t.selectPrevVillage(),!1):40===e.keyCode?(t.selectNextVillage(),!1):13!==e.keyCode||(t.confirmVillageAtIndex(t.selected_index),!1)},this.selectNextVillage=function(){null===this.selected_index?this.selectVillageAtIndex(0):this.selected_index+1<=this.num_villages&&this.selectVillageAtIndex(this.selected_index+1)},this.selectPrevVillage=function(){null!==this.selected_index&&this.selected_index>0&&this.selectVillageAtIndex(this.selected_index-1)},this.selectVillageAtIndex=function(e){this.unselectSelectedVillage();var t=this.getAutoCompleteWrapper().find("div").eq(e);t.addClass("village-selected"),this.selected_index=e;var i=41*e,a=t.position().top,l=parseInt(t.parent().css("max-height"));a<10?t.parent().scrollTop(i):a>l-40&&t.parent().scrollTop(i)},this.unselectSelectedVillage=function(){this.getAutoCompleteWrapper().find("div.village-selected").removeClass("village-selected")},this.confirmVillageAtIndex=function(e){var t=this.getAutoCompleteWrapper().find("div").eq(e);t.length&&(t.hasClass("village-more")?(this.loadMoreVillages(),this.selectVillageAtIndex(e-1)):this.confirmVillage(t))},this.updateURLForConfirmedVillage=function(){var e=this.confirmed_village_data?this.confirmed_village_data:{id:0},t=document.location.href;"#"===t.substr(-1)&&(t=t.substr(0,t.length-1));var i=/target=([0-9]+)/;t.match(i)?t=t.replace(i,"target="+e.id):t+="&target="+e.id,Modernizr.history&&history.replaceState({},"",t)},this.loadMoreVillages=function(){this.fetchVillages({offset:this.num_villages})},this.construct(e)}).loadTargetsPopup=function(e,t){UI.AjaxPopup(e,"village_targets",t,_("91fadc5613280f76b916f1fd236e43e9"),null,{reload:!0},null,400)}}();
